#!/usr/bin/env bash
set -euo pipefail

# This script can be called from the web. If this is the case, clone the
# dotfiles repository to the expected install location. Also ensure we're in
# the correct install directory. After this point the install/upgrade
# procedures should be the same.
if [ ! -d ~/dotfiles ]; then
    git clone git@github.com:jamesbehr/dotfiles.git ~/dotfiles
fi

cd ~/dotfiles

# Install any missing packages. This will usually help install GNU Stow which
# is needed for the following steps
./backpack

DOTFILESRC=${DOTFILESRC:-"$HOME/.dotfilesrc"}

if [ ! -f "$DOTFILESRC" ]; then
    echo "Creating default dotfiles configuration"
    cp .dotfilesrc "$DOTFILESRC"
fi

echo "Loading dotfiles configuration"
source "$DOTFILESRC"

# Don't attempt to "fold" trees of symlinks by creating a symlink to a
# directory - always create symlinks to the leaves of the tree. This
# prevents "contamination" of the Git repository when an external
# application writes to a directory that was created by Stow. If we
# symlinked to a directory, any files added to that directory would
# suddenly appear in the repository which is undesired behaviour.
IFS=:
for package in $DOTFILES_PACKAGES; do
    echo "Symlinking $package dotfiles"
	stow --restow --no-folding "$package"
done
